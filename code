# Instalar e carregar as bibliotecas necessárias

install.packages('stringr')
library(stringr)


# Função para calcular AAPC usando regressão Poisson _ INCIDENCIA

calcular_aapc_poisson <- function(casos, populacao, anos) {
        modelo <- glm(casos ~ Anos + offset(log(populacao)), family = poisson(link = "log"))
        coef_ano <- coef(modelo)[2]
        ic <- confint(modelo)[2,]
        ic_lower <- ic[1]
        ic_upper <- ic[2]
        aapc <- ((exp(coef_ano) - 1) / (anos[length(anos)] - anos[1])) * 100
        aapc2 <- (exp(coef_ano) - 1) * 100
        erro_padrao <- coef(summary(modelo))[2, "Std. Error"]
        p_valor <- coef(summary(modelo))[2, "Pr(>|z|)"]
        
        resultado <- list(
                p_valor = p_valor,
                ic_lower = ic_lower,
                ic_upper = ic_upper,
                erro_padrao = erro_padrao,
                aapc = aapc
        )
        
        return(resultado)
}

# Função para calcular AAPC usando regressão binomial_PREVALENCIA

calcular_aapc_binomial <- function(eventos, tamanho_amostra, anos) {
        modelo <- glm(cbind(eventos, tamanho_amostra - eventos) ~ anos, family = binomial(link = "logit"))
        coef_ano <- coef(modelo)[2]
        ic <- confint(modelo)[2,]
        ic_lower <- ic[1]
        ic_upper <- ic[2]
        aapc <- ((exp(coef_ano) - 1) / (anos[length(anos)] - anos[1])) * 100
        aapc2 <- (exp(coef_ano) - 1) * 100
        erro_padrao <- coef(summary(modelo))[2, "Std. Error"]
        p_valor <- coef(summary(modelo))[2, "Pr(>|z|)"]
        
        resultado <- list(
                p_valor = p_valor,
                ic_lower = ic_lower,
                ic_upper = ic_upper,
                erro_padrao = erro_padrao,
                aapc = aapc,
                aapc2 = aapc2,
                modelo = modelo
        )
        
        return(resultado)
}



# Calcular AAPC e resultados usando regressão Poisson
# resultado_poisson <- calcular_aapc_poisson(casos, populacao, anos)





cat("Análise de Prevalência (Binomial):\n",
    "AAPC:", Casos_binomial_prevalencia$aapc, "%\n", 
    "AAPC2:", Casos_binomial_prevalencia$aapc2, "%\n",
    "IC 95%:", Casos_binomial_prevalencia$ic_lower, "-", Casos_binomial_prevalencia$ic_upper, "%\n",
    "Erro Padrão:", Casos_binomial_prevalencia$erro_padrao, "\n",
    "Valor de p:", Casos_binomial_prevalencia$p_valor, "\n")


